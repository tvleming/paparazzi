<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="TVL">
  <description>TVL Forwardswept</description>

  <firmware name="rotorcraft">
    <configure name="PERIODIC_FREQUENCY"  value="500"/>

    <target name="ap" board="px4fmu_4.0_chibios">

      <module name="radio_control" type="sbus">
        <!-- <define name="RADIO_KILL_SWITCH" value="RADIO_AUX1"/> -->
      </module> 
    </target>

    <target name="nps" board="pc">
      <module name="radio_control" type="spektrum"/>
      <module name="fdm" type="jsbsim"/>
    </target>

    <module name="actuators"     type="pwm">
      <define name="SERVO_HZ"    value="100"/>
    </module>
    <module name="telemetry"     type="transparent">
      <configure name="MODEM_PORT" value="UART3"/><!--  Telem2 on pixracer (default is Telem1) -->
      <configure name="MODEM_BAUD" value="B57600"/><!-- set B9600 later on for distance since modem will be set to lower *air*rate thus higher sensitivity -->
    </module>
    <module name="imu" type="mpu9250_spi">
      <configure name="IMU_MPU9250_SPI_DEV" value="spi1"/>
      <configure name="IMU_MPU9250_SPI_SLAVE_IDX" value="SPI_SLAVE2"/>
      <define name="IMU_MPU9250_READ_MAG" value="FALSE"/>
    </module>
    <module name="gps"           type="ublox">
      <configure name="GPS_BAUD" value="B460800"/>
    </module>
    <module name="gps"           type="ubx_ucenter"/>
    <module name="stabilization" type="int_quat"/>
    <module name="stabilization" type="rate"/>
    <module name="guidance"      type="hybrid"/>
    <module name="ins"           type="extended"/>

    <module name="ahrs" type="float_cmpl_quat"> <!-- Compare e.g. float_dcm -->
        <configure name="AHRS_USE_MAGNETOMETER" value="TRUE"/> <!-- as in USE it for values in the AHRS -->
        <configure name="AHRS_ALIGNER_LED" value="2"/><!-- Which color you want sir? ;) -->
        <define name="AHRS_MAG_UPDATE_ALL_AXES" value="TRUE"/> <!-- if TRUE with those high roll n pith angles magneto should be calibrated well or use UKF autocalib -->
        <define name="AHRS_USE_GPS_HEADING" value="TRUE"/><!-- TRUE by default Use GPS course to update heading for time being,if FALSE data from magneto only -->
        <!-- <define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN" value="FALSE"/>--> <!--Already TRUE by default Compensation of centrifugal force via GPS speed (to fly in circles with a fixedwing)"-->
        <define name="AHRS_GPS_SPEED_IN_NEGATIVE_Z_DIRECTION" value="FALSE"/> <!-- AHRS_GRAVITY_UPDATE_COORDINATED_TURN assumes the GPS speed is in the X axis direction. Quadshot, DelftaCopter and other hybrids can have the GPS speed in the negative Z direction" -->
        <define name="AHRS_PROPAGATE_LOW_PASS_RATES" value="FALSE"/> <!-- apply a low pass filter on rotational velocity"-->
        <define name="AHRS_BIAS_UPDATE_HEADING_THRESHOLD" value="0.174533" unit="rad"/> <!-- don't update gyro bias if heading deviation is above this rotation threshold"-->
        <define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="3.0" unit="m/s"/> <!-- CAREFULL,  Don't update heading from GPS course if GPS ground speed is below is this threshold in m/s" -->
        <!-- Some insights https://lists.nongnu.org/archive/html/paparazzi-devel/2013-10/msg00126.html -->
        <define name="AHRS_GRAVITY_HEURISTIC_FACTOR" value="0.5"/> <!-- TODO: determine Default is 30. Reduce accelerometer cut-off frequency when the vehicle is accelerating: norm(ax,ay,az) 9,81 m/s2. WARNING: when the IMU is not well damped, the norm of accelerometers never equals to 9,81 m/s2. As a result, the GRAVITY_HEURISTIC_FACTOR will reduce the accelerometer bandwith even if the vehicle is not accelerating. -->
        <define name="AHRS_ICQ_IMU_ID" value="ABI_BROADCAST"/> <!-- ABI sender id of IMU to use -->
        <define name="AHRS_ICQ_MAG_ID" value="MAG_CALIB_UKF_ID" /><!-- for when using the mag_clib_ukf -->
    </module>

    <module name="mag" type="hmc58xx">
      <!-- We will use the magnetometer that is available on our GPS board
         Thi one is temperature compensated and furthest away from all other devices
         so less influence (still to measure raw mag values to check this though )
         In case we where sloppy building in the GPS+mag combo , we always are ;)
         we need to compensate this a bit e.g. the pitch
         lucky the tree axis are aligned already in hardware ;) -->
      <!-- <define name="MAG_TO_IMU_THETA" value="6" unit="deg"/>-->
        <configure name="MAG_HMC58XX_I2C_DEV" value="i2c1"/>
        <define name="MODULE_HMC58XX_UPDATE_AHRS" value="FALSE"/><!-- When all calib and works to TRUE -->
        <define name="HMC58XX_CHAN_X" value="1"/>
        <define name="HMC58XX_CHAN_Y" value="0"/>
        <define name="HMC58XX_CHAN_Z" value="2"/>
        <define name="HMC58XX_CHAN_X_SIGN" value="-"/>
        <define name="HMC58XX_CHAN_Y_SIGN" value="+"/>
        <define name="HMC58XX_CHAN_Z_SIGN" value="+"/>
      </module>

    <!-- Logger -->
    <!-- <module name="flight_recorder"/> -->

    <module name="air_data"/>
  </firmware>

  <servos driver="Pwm">
    <servo name="S_AILERON_LEFT" no="0" min="1900" neutral="1500" max="1100"/>
    <servo name="S_ELEVATOR" no="1" min="1100" neutral="1500" max="1900"/>
    <servo name="S_RUDDER" no="2" min="1900" neutral="1500" max="1100"/>
    <servo name="S_THROTTLE_LEFT" no="3" min="1000" neutral="1000" max="2000"/>
    <servo name="S_THROTTLE_RIGHT" no="4" min="1000" neutral="1000" max="2000"/>
    <servo name="S_AILERON_RIGHT" no="5" min="1900" neutral="1500" max="1100"/>
  </servos>

  <commands>
    <axis name="ROLL"   failsafe_value="0"/>
    <axis name="PITCH"  failsafe_value="0"/>
    <axis name="YAW"    failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="0"/>
  </commands>

  <command_laws>
    <set servo="S_ELEVATOR" value="@PITCH"/>
    <set servo="S_RUDDER" value="@YAW"/>
    <set servo="S_THROTTLE_LEFT" value="(((@THRUST + @YAW) < 0 ? 0 : (@THRUST + @YAW)))"/>
    <set servo="S_THROTTLE_RIGHT" value="(((@THRUST - @YAW) < 0 ? 0 : (@THRUST - @YAW)))"/>
    <set servo="S_AILERON_LEFT" value="@ROLL"/>
    <set servo="S_AILERON_RIGHT" value="@ROLL"/>
  </command_laws>

  <section name="MISC">
    <define name="NAV_CLIMB_VSPEED" value="2.5"/>
    <define name="NAV_DESCEND_VSPEED" value="-1.0"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
  </section>

  <section name="IMU" prefix="IMU_">
    <!--define name="ACCEL_X_NEUTRAL" value="0"/>
    <define name="ACCEL_Y_NEUTRAL" value="0"/>
    <define name="ACCEL_Z_NEUTRAL" value="0"/>
    <define name="ACCEL_X_SENS" value="4.88671674253" integer="16"/>
    <define name="ACCEL_Y_SENS" value="4.85140885386" integer="16"/>
    <define name="ACCEL_Z_SENS" value="4.89977338537" integer="16"/-->

    <!-- replace this with your own calibration -->
    <define name="MAG_X_NEUTRAL" value="-48"/>
    <define name="MAG_Y_NEUTRAL" value="69"/>
    <define name="MAG_Z_NEUTRAL" value="155"/>
    <define name="MAG_X_SENS" value="7.646781508055661" integer="16"/>
    <define name="MAG_Y_SENS" value="7.71865134635356" integer="16"/>
    <define name="MAG_Z_SENS" value="7.691679165490501" integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI"   value="70." unit="deg"/>
  </section>

  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <define name="H_X" value="0.3770441"/>
    <define name="H_Y" value="0.0193986"/>
    <define name="H_Z" value="0.9259921"/>
    <define name="USE_GPS_HEADING" value="0"/>
  </section>

  <section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
    <!-- setpoints -->
    <define name="SP_MAX_P" value="700" unit="deg/s"/>
    <define name="SP_MAX_Q" value="700" unit="deg/s"/>
    <define name="SP_MAX_R" value="200" unit="deg/s"/>
    <define name="DEADBAND_P" value="20"/>
    <define name="DEADBAND_Q" value="20"/>
    <define name="DEADBAND_R" value="400"/>

    <!-- feedback -->
    <define name="GAIN_P" value="700"/>
    <define name="GAIN_Q" value="700"/>
    <define name="GAIN_R" value="200"/>

    <define name="IGAIN_P" value="75"/>
    <define name="IGAIN_Q" value="75"/>
    <define name="IGAIN_R" value="50"/>
  </section>

  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI" value="500." unit="deg"/>
    <define name="SP_MAX_THETA" value="500." unit="deg"/>
    <define name="SP_MAX_R" value="500." unit="deg/s"/>
    <define name="DEADBAND_R" value="200"/>

    <!-- reference -->
    <define name="REF_OMEGA_P" value="800" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.85"/>
    <define name="REF_MAX_P" value="300." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(7000.)"/>

    <define name="REF_OMEGA_Q" value="800" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.85"/>
    <define name="REF_MAX_Q" value="300." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(7000.)"/>

    <define name="REF_OMEGA_R" value="500" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.85"/>
    <define name="REF_MAX_R" value="180." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(1800.)"/>

    <!-- feedback -->
    <define name="PHI_PGAIN" value="4000"/>
    <define name="PHI_DGAIN" value="700"/>
    <define name="PHI_IGAIN" value="10"/>

    <define name="THETA_PGAIN" value="4000"/>
    <define name="THETA_DGAIN" value="700"/>
    <define name="THETA_IGAIN" value="10"/>
    
    <define name="PSI_PGAIN" value="4000"/>
    <define name="PSI_DGAIN" value="200"/>
    <define name="PSI_IGAIN" value="10"/>

    <!-- feedforward -->
    <define name="PHI_DDGAIN" value="0"/>
    <define name="THETA_DDGAIN" value="0"/>
    <define name="PSI_DDGAIN" value="0"/>
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP"    value="250"/>
    <define name="HOVER_KD"    value="90"/>
    <define name="HOVER_KI"    value="5"/>
    <define name="NOMINAL_HOVER_THROTTLE" value="0.5"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE"/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="MAX_BANK" value="35" unit="deg"/>
    <define name="USE_SPEED_REF" value="TRUE"/>
    <define name="PGAIN" value="60"/>
    <define name="DGAIN" value="100"/>
    <define name="AGAIN" value="0"/>
    <define name="IGAIN" value="20"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="nw_motor, ne_motor, se_motor, sw_motor" type="string[]"/>
    <define name="JSBSIM_MODEL" value="simple_x_quad_ccw" type="string"/>
    <!-- mode switch on joystick channel 5 (axis numbering starting at zero) -->
    <define name="JS_AXIS_MODE" value="4"/>
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_MANUAL" value="AP_MODE_RC_DIRECT"/>
    <define name="MODE_AUTO1"  value="AP_MODE_RATE_DIRECT"/>
    <define name="MODE_AUTO2"  value="AP_MODE_NAV"/>
    <!-- <define name="MODE_AUTO2"  value="AP_MODE_ATTITUDE_DIRECT"/> -->

  </section>

<section name="BAT">
    <define name="MAX_BAT_CAPACITY" value="1300" unit="mAh"/> <!--2x 650 mAh batteries-->
    <!--<define name="MilliAmpereOfAdc(_adc)" value="(_adc-632)*4.14"/>--> <!-- TODO: calibrate even better -->
    <!-- tested at V 11.7 the avg -->  <!-- 1idel RPM then 1.0A half throttle 4A-->
    <define name="VoltageOfAdc(adc)" value="16.8"/>
    <define name="MILLIAMP_AT_IDLE_THROTTLE" value="600" unit="mA"/>  <!-- 500mA, with additional RC receiver ~600mA -->
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="11000" unit="mA"/> <!-- At 11.7 10.6 A at 12.2v 11.0A rounded then to 11000 to be at safe side-->
    <define name="MAX_BAT_LEVEL" value="16.8" unit="V"/> <!-- 4S lipo 4x4.2 = 16.8 -->
    <define name="LOW_BAT_LEVEL" value="14.0" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="13.3" unit="V"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="12.0" unit="V"/> <!-- TODO: test when AP board switches off -->
    <define name="MIN_BAT_LEVEL" value="12.0" unit="V"/><!-- Get rid if this one maybe? -->
  </section>

</airframe>
